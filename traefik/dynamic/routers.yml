# Traefik Dynamic Configuration - Routers
# Production routers for cluebase.ai

http:
  routers:
    # API Router
    api-secure:
      rule: "Host(`api.cluebase.ai`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - cors-api
        - rate-limit
        - compress
      service: api
      tls:
        certResolver: letsencrypt

    # Dashboard Router
    dashboard-secure:
      rule: "Host(`cluebase.ai`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - compress
      service: dashboard
      tls:
        certResolver: letsencrypt

    # Supabase Gateway (Kong) Router
    supabase-secure:
      rule: "Host(`supabase.cluebase.ai`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - cors-supabase
      service: kong
      tls:
        certResolver: letsencrypt

  middlewares:
    # CORS for Supabase
    cors-supabase:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "https://cluebase.ai"
          - "https://www.cluebase.ai"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100

  services:
    api:
      loadBalancer:
        servers:
          - url: "http://api:3000"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 10s

    dashboard:
      loadBalancer:
        servers:
          - url: "http://dashboard:3001"
        healthCheck:
          path: /
          interval: 30s
          timeout: 10s

    kong:
      loadBalancer:
        servers:
          - url: "http://kong:8000"
